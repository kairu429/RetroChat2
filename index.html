<script>
document.addEventListener("DOMContentLoaded", () => {
  const firebaseConfig = { databaseURL:"https://retrochat-74f95-default-rtdb.firebaseio.com/" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let username = null;
  let roomID = null;
  let userKey = null;
  let isWorld = false;

  const menu = document.getElementById("menu");
  const roomMenu = document.getElementById("roomMenu");
  const chatroom = document.getElementById("chatroom");
  const chatDiv = document.getElementById("chat");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const setNameBtn = document.getElementById("setNameBtn");
  const usernameInput = document.getElementById("usernameInput");
  const userListDiv = document.getElementById("userList");

  setNameBtn.addEventListener("click", ()=>{
    const inputName = usernameInput.value.trim();
    if(inputName){
      username = inputName.slice(0,20);
      alert(`名前が「${username}」に設定されました`);
      menu.style.display="none";
      roomMenu.style.display="flex";
    } else {
      alert("名前を入力してください");
    }
  });

  function joinRoom(rid){
    roomID = rid;
    isWorld = (rid==="world");
    roomMenu.style.display="none";
    chatroom.style.display="flex";
    const roomRef = db.ref("rooms/"+roomID);

    userKey = roomRef.child("users").push().key;
    roomRef.child("users/"+userKey).set(username);

    window.addEventListener("beforeunload", ()=>{
      roomRef.child("users/"+userKey).remove();
    });

    // --- チャットリアルタイム更新 ---
    roomRef.child("chat").on("child_added", snapshot=>{
      const data = snapshot.val();
      const p = document.createElement('p');
      let nameSpan = document.createElement("span");
      nameSpan.textContent = data.username;
      if(!isWorld && data.username===username) nameSpan.className="ownerName";
      p.appendChild(document.createTextNode("["));
      p.appendChild(nameSpan);
      p.appendChild(document.createTextNode("] "));
      if(data.content.match(/^https?:\/\/.*\.(jpg|jpeg|png|gif)$/i)){
        const img = document.createElement("img");
        img.src = data.content;
        img.className = "chatImage";
        p.appendChild(img);
      } else {
        p.appendChild(document.createTextNode(data.content));
      }
      chatDiv.appendChild(p);
      chatDiv.scrollTop = chatDiv.scrollHeight;
    });

    // --- ユーザーリストもリアルタイム更新 ---
    roomRef.child("users").on("value", snapshot=>{
      userListDiv.innerHTML="";
      snapshot.forEach(s=>{
        const p = document.createElement("div");
        p.textContent = s.val();
        if(!isWorld && s.key===userKey) p.className="ownerName";
        userListDiv.appendChild(p);
      });
    });
  }

  function sendMessage(){
    const content = msgInput.value.trim();
    if(content && roomID){
      db.ref("rooms/"+roomID+"/chat").push({ username, content, timestamp:Date.now() });
      msgInput.value="";
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  msgInput.addEventListener("keydown", e=>{
    if(e.key==="Enter") sendMessage();
  });

  document.getElementById("worldBtn").addEventListener("click", ()=> joinRoom("world"));
  document.getElementById("joinBtn").addEventListener("click", ()=>{
    let code = prompt("招待コードを入力");
    if(code) joinRoom(code);
  });

  // --- 古いメッセージ自動削除（30日以上） ---
  setInterval(()=>{
    db.ref("rooms/world/chat").once("value").then(snap=>{
      snap.forEach(msg=>{
        if(Date.now() - msg.val().timestamp > 30*24*60*60*1000){
          msg.ref.remove();
        }
      });
    });
  }, 24*60*60*1000);

});
</script>
