<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RetroChat</title>
<style>
body { font-family: sans-serif; margin:0; height:100vh; display:flex; justify-content:center; align-items:center; background:#f6f6f6; }
#chatroom { display:flex; flex-direction:column; width:80vw; max-width:600px; height:80vh; background:#fff; box-shadow:0 2px 8px rgba(0,0,0,0.08); padding:16px; border-radius:8px; }
#chat { flex:1; border:1px solid #eee; padding:8px; overflow-y:auto; margin-bottom:8px; background:#fafafa; border-radius:6px; }
.message { margin:6px 0; padding:6px 8px; border-radius:6px; background: #fff; box-shadow: 0 1px 0 rgba(0,0,0,0.02); }
.meta { font-size:0.8em; color:#666; margin-bottom:4px; }
#usernameInput { padding:6px 8px; font-size:1em; margin-bottom:8px; border:1px solid #ddd; border-radius:6px; width:200px; }
#msgInput { flex:1; padding:10px; font-size:1em; border:1px solid #ddd; border-radius:6px; }
#sendBtn { padding:10px 16px; font-size:1em; margin-left:8px; border-radius:6px; border:none; background:#007bff; color:#fff; cursor:pointer; }
.inputContainer { display:flex; align-items:center; gap:8px; margin-top:8px; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

<div id="chatroom">
  <input id="usernameInput" placeholder="名前を入力 (未入力でNotName)" />
  <div id="chat"></div>
  <div class="inputContainer">
    <input id="msgInput" placeholder="メッセージを入力" />
    <button id="sendBtn">送信</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const SUPABASE_URL = "https://zwxtdpvxozlsvvqktmxk.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3eHRkcHZ4b3psc3Z2cWt0bXhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUyNjEyMDIsImV4cCI6MjA3MDgzNzIwMn0.t6E4KU0WrZuavyRqzMdw6N2yWt_whIed-W7nRzl2cnE";
  const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const chatDiv = document.getElementById("chat");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const usernameInput = document.getElementById("usernameInput");

  function appendMessage({ username, content, created_at }) {
    const wrapper = document.createElement('div');
    wrapper.className = 'message';
    const meta = document.createElement('div');
    meta.className = 'meta';
    meta.textContent = `[${username || "NotName"}] ${created_at ? new Date(created_at).toLocaleTimeString() : ''}`;
    const body = document.createElement('div');
    body.textContent = content;
    wrapper.appendChild(meta);
    wrapper.appendChild(body);
    chatDiv.appendChild(wrapper);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  async function loadHistory() {
    const { data } = await supabase.from('Chat')
      .select('*')
      .order('id', { ascending: true })
      .limit(200);
    chatDiv.innerHTML = '';
    data.forEach(appendMessage);
  }

  function subscribeRealtime() {
    supabase.from('Chat').on('INSERT', payload => appendMessage(payload.new)).subscribe();
  }

  async function sendMessage() {
    const username = usernameInput.value.trim() || "NotName";
    const content = msgInput.value.trim();
    if (!content) return;
    await supabase.from('Chat').insert([{ username, content }]);
    msgInput.value = "";
  }

  sendBtn.addEventListener('click', sendMessage);
  msgInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  loadHistory();
  subscribeRealtime();
});
</script>

</body>
</html>
