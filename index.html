<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>RetroChat URL画像対応</title>
<style>
body {
  font-family: monospace;
  margin:0;
  height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
  background-color:black;
  color:limegreen;
}
#chatroom {
  display:flex;
  flex-direction:column;
  width:80vw;
  max-width:600px;
  height:80vh;
  border:1px solid limegreen;
}
#chat {
  flex:1;
  border:1px solid limegreen;
  padding:5px;
  overflow-y:auto;
  background-color:black;
}
input {
  padding:10px;
  font-size:1em;
  background:black;
  color:limegreen;
  border:1px solid limegreen;
  flex:1;
}
button {
  padding:10px 20px;
  font-size:1em;
  margin-left:5px;
  background:black;
  color:limegreen;
  border:1px solid white;
  cursor:pointer;
}
button:hover {
  background:#111;
}
.inputContainer {
  display:flex;
  margin-top:5px;
}
.chatImage {
  max-width:200px;
  max-height:150px;
  border:2px solid limegreen;
  margin:5px 0;
  display:block;
  image-rendering: pixelated;
  transition: transform 0.2s;
}
.chatImage:hover {
  transform:scale(1.1);
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>

<div id="chatroom">
  <div id="chat"></div>

  <div class="inputContainer">
    <input id="msgInput" placeholder="メッセージまたは画像URLを入力" />
    <button id="sendBtn">送信</button>
  </div>

  <div class="inputContainer">
    <input id="usernameInput" placeholder="名前を入力（20文字以内）" maxlength="20" />
    <button id="setNameBtn">OK</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const firebaseConfig = {
    databaseURL: "https://retrochat-74f95-default-rtdb.firebaseio.com/"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const chatDiv = document.getElementById("chat");
  const sendBtn = document.getElementById("sendBtn");
  const setNameBtn = document.getElementById("setNameBtn");
  const msgInput = document.getElementById("msgInput");
  let username = "匿名";

  // 名前設定
  setNameBtn.addEventListener("click", () => {
    const inputName = document.getElementById("usernameInput").value.trim();
    if(inputName){
      username = inputName.slice(0,20);
      alert(`名前が「${username}」に設定されました`);
    } else {
      alert("名前を入力してください");
    }
  });

  // メッセージ送信
  function sendMessage(content){
    if(content.trim()){
      db.ref("chat").push({ username, content });
      msgInput.value="";
    }
  }

  sendBtn.addEventListener("click", ()=> sendMessage(msgInput.value));
  msgInput.addEventListener("keydown", e => {
    if(e.key === "Enter") sendMessage(msgInput.value);
  });

  // チャット更新
  db.ref("chat").on("child_added", snapshot=>{
    const data = snapshot.val();

    // URLが画像なら img として表示
    if(data.content.match(/^https?:\/\/.*\.(jpg|jpeg|png|gif)$/i)){
      const img = document.createElement("img");
      img.src = data.content;
      img.className = "chatImage";
      chatDiv.appendChild(img);
    } else {
      const p = document.createElement('p');
      p.textContent = `[${data.username}] ${data.content}`;
      chatDiv.appendChild(p);
    }
    chatDiv.scrollTop = chatDiv.scrollHeight;
  });
});
</script>

</body>
</html>
