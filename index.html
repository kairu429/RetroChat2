<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>RetroChat</title>
<style>
body { 
  font-family: monospace; 
  margin:0; 
  height:100vh; 
  display:flex; 
  justify-content:center; 
  align-items:center; 
  background-color: black; 
  color: limegreen;
}
#login, #chatroom { 
  display:none; 
  flex-direction:column; 
  width:80vw; 
  max-width:600px; 
  height:80vh; 
}
#login { align-items:center; }
#chatroom { display:flex; flex-direction:column; }
#chat { 
  flex:1; 
  border:1px solid limegreen; 
  padding:5px; 
  overflow-y:auto; 
  margin-bottom:5px; 
}
#msgInput { 
  flex:1; 
  padding:10px; 
  font-size:1em; 
  background:black; 
  color:limegreen; 
  border:1px solid limegreen; 
}
#sendBtn, #enterBtn { 
  padding:10px 20px; 
  font-size:1em; 
  margin-left:5px; 
  background:black; 
  color:limegreen; 
  border:1px solid white; 
  cursor:pointer;
}
#sendBtn:hover, #enterBtn:hover {
  background:#111;
}
.inputContainer { display:flex; }
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
</head>
<body>

<div id="login">
  <h2>名前を入力してください</h2>
  <input id="usernameInput" placeholder="名前" style="background:black; color:limegreen; border:1px solid limegreen; padding:10px;">
  <button id="enterBtn">次へ</button>
</div>

<div id="chatroom">
  <div id="chat"></div>
  <div class="inputContainer">
    <input id="msgInput" placeholder="メッセージを入力" />
    <button id="sendBtn">送信</button>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const supabaseUrl = "https://zwxtdpvxozlsvvqktmxk.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
  const supabase = supabase.createClient(supabaseUrl, supabaseKey);

  const loginDiv = document.getElementById("login");
  const chatroomDiv = document.getElementById("chatroom");
  const chatDiv = document.getElementById("chat");
  const enterBtn = document.getElementById("enterBtn");
  const sendBtn = document.getElementById("sendBtn");

  let username = "";

  enterBtn.addEventListener("click", () => {
    username = document.getElementById("usernameInput").value.trim();
    if (!username) return alert("名前を入力してください");

    loginDiv.style.display = "none";
    chatroomDiv.style.display = "flex";

    const msgInput = document.getElementById("msgInput");

    // 入室メッセージ
    supabase.from('Chat').insert([{ username, content: `${username}さんが入室しました` }]);

    // リアルタイム購読
    supabase
      .from('Chat')
      .on('INSERT', payload => {
        const p = document.createElement('p');
        p.textContent = `[${payload.new.username}] ${payload.new.content}`;
        chatDiv.appendChild(p);
        chatDiv.scrollTop = chatDiv.scrollHeight;
      })
      .subscribe();
  });

  window.sendMessage = function() {
    const msgInput = document.getElementById("msgInput");
    if (msgInput.value.trim()) {
      supabase.from('Chat').insert([{ username, content: msgInput.value }]);
      msgInput.value = "";
    }
  };

  sendBtn.addEventListener("click", () => {
    if (!username) return alert("まず名前を入力してください");
    sendMessage();
  });

  window.addEventListener('beforeunload', () => {
    username = "";
    loginDiv.style.display = "flex";
    chatroomDiv.style.display = "none";
  });

  loginDiv.style.display = "flex";
});
</script>

</body>
</html>
