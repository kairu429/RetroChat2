<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>RetroChat ワールド＆招待コード版</title>
<style>
body { font-family: monospace; margin:0; height:100vh; display:flex; justify-content:center; align-items:center; background-color:black; color:limegreen;}
#chatroom {
  display:flex;
  width:80vw;
  max-width:800px;
  height:80vh;
  border:1px solid limegreen;
  background:black;
}
#userList {
  width:150px;
  border-right:1px solid limegreen;
  padding:5px;
  overflow-y:auto;
  font-size:0.8em;
  background:black;
}
#chatContainer {
  flex:1;
  display:flex;
  flex-direction:column;
}
#chat {
  flex:1;
  border-bottom:1px solid limegreen;
  padding:5px;
  overflow-y:auto;
}
.inputContainer { display:flex; margin-top:5px; }
input { padding:10px; font-size:1em; background:black; color:limegreen; border:1px solid limegreen; flex:1; }
button { padding:10px 20px; font-size:1em; margin-left:5px; background:black; color:limegreen; border:1px solid white; cursor:pointer; }
button:hover { background:#111;}
.chatImage { max-width:200px; max-height:150px; border:2px solid limegreen; margin:5px 0; display:block; image-rendering: pixelated; transition: transform 0.2s;}
.chatImage:hover { transform:scale(1.1);}
.ownerName { color: yellow; font-weight: bold; }
#menu { display:flex; flex-direction:column; align-items:center;}
.menuBtn { padding:10px 20px; margin:5px; background:black; color:limegreen; border:1px solid limegreen; cursor:pointer;}
.menuBtn:hover { background:#111;}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
<div id="chatroom" style="display:none;">
  <div id="userList"></div>
  <div id="chatContainer">
    <div id="chat"></div>
    <div class="inputContainer">
      <input id="msgInput" placeholder="メッセージまたは画像URLを入力" />
      <button id="sendBtn">送信</button>
    </div>
  </div>
</div>

<div id="menu">
  <h2>どこに行きますか？</h2>
  <input id="usernameInput" placeholder="名前を入力（20文字以内）" maxlength="20"/>
  <button class="menuBtn" id="worldBtn">全世界</button>
  <button class="menuBtn" id="joinBtn">招待に参加</button>
  <button class="menuBtn" id="createBtn">招待を作成</button>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const firebaseConfig = { databaseURL:"https://retrochat-74f95-default-rtdb.firebaseio.com/" };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let username = null;
  let roomID = null;
  let userKey = null;
  let isWorld = false;

  const menu = document.getElementById("menu");
  const chatroom = document.getElementById("chatroom");
  const chatDiv = document.getElementById("chat");
  const msgInput = document.getElementById("msgInput");
  const sendBtn = document.getElementById("sendBtn");
  const usernameInput = document.getElementById("usernameInput");
  const userListDiv = document.getElementById("userList");

  function cleanupOldMessages(rid){
    const cutoff = Date.now() - (30*24*60*60*1000); // 30日
    db.ref("rooms/"+rid+"/chat").once("value", snap=>{
      snap.forEach(c=>{
        if(c.val().timestamp < cutoff){
          c.ref.remove();
        }
      });
    });
  }

  function joinRoom(rid, creating=false){
    roomID = rid;
    isWorld = (rid==="world");

    username = usernameInput.value.trim();
    if(!username){
      alert("名前を入力してください");
      return;
    }

    menu.style.display="none";
    chatroom.style.display="flex";
    const roomRef = db.ref("rooms/"+roomID);

    roomRef.once("value").then(snap=>{
      if(!snap.exists()){
        // 新規ルーム作成時 → owner 設定
        roomRef.set({
          createdAt: Date.now(),
          owner: isWorld ? null : username
        });
      }
      registerUser(roomRef);
    });

    function registerUser(roomRef){
      userKey = roomRef.child("users").push().key;
      const userRef = roomRef.child("users/"+userKey);
      userRef.set(username);
      userRef.onDisconnect().remove();

      window.addEventListener("beforeunload", ()=>{
        userRef.remove();
      });

      // チャット受信
      roomRef.child("chat").on("child_added", snapshot=>{
        const data = snapshot.val();
        const p = document.createElement('p');

        roomRef.once("value").then(rSnap=>{
          const roomData = rSnap.val();
          let nameSpan = document.createElement("span");
          nameSpan.textContent = data.username;
          if(!isWorld && roomData && data.username === roomData.owner){
            nameSpan.className="ownerName";
          }
          p.appendChild(document.createTextNode("["));
          p.appendChild(nameSpan);
          p.appendChild(document.createTextNode("] "));
          if(data.content.match(/^https?:\/\/.*\.(jpg|jpeg|png|gif)$/i)){
            const img = document.createElement("img");
            img.src = data.content;
            img.className = "chatImage";
            p.appendChild(img);
          } else {
            p.appendChild(document.createTextNode(data.content));
          }
          chatDiv.appendChild(p);
          chatDiv.scrollTop = chatDiv.scrollHeight;
        });
      });

      // ユーザーリスト更新
      roomRef.on("value", snap=>{
        const val = snap.val();
        userListDiv.innerHTML="";
        if(val && val.users){
          Object.entries(val.users).forEach(([key, name])=>{
            const p = document.createElement("div");
            p.textContent = name;
            if(!isWorld && name === val.owner){
              p.className="ownerName";
            }
            userListDiv.appendChild(p);
          });
        } else {
          if(!isWorld){
            roomRef.remove();
          }
        }
      });
    }
  }

  function sendMessage(){
    const content = msgInput.value.trim();
    if(content && roomID){
      db.ref("rooms/"+roomID+"/chat").push({
        username,
        content,
        timestamp: Date.now()
      });
      msgInput.value="";
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  msgInput.addEventListener("keydown", e=>{
    if(e.key==="Enter") sendMessage();
  });

  document.getElementById("worldBtn").addEventListener("click", ()=> joinRoom("world"));
  document.getElementById("joinBtn").addEventListener("click", ()=>{
    let code = prompt("招待コードを入力");
    if(code) joinRoom(code);
  });
  document.getElementById("createBtn").addEventListener("click", ()=>{
    let code = Math.random().toString(36).substring(2,8);
    alert("招待コード: "+code);
    joinRoom(code, true);
  });

  // 1日ごとに古いチャット掃除
  setInterval(()=>{
    db.ref("rooms").once("value", snap=>{
      snap.forEach(room=>{
        cleanupOldMessages(room.key);
      });
    });
  }, 24*60*60*1000);

});
</script>
</body>
</html>
